name: Playwright Tests with Allure and GitHub Pages Deployment

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/main.yaml'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Prevent multiple concurrent deployments and test runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip if commit is from dependabot or contains [skip ci]
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      github.actor != 'dependabot[bot]'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    strategy:
      matrix:
        browser: [chromium]
      fail-fast: false

    steps:
      # ============================================
      # Checkout & Setup
      # ============================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: requirements.txt

      # ============================================
      # Environment Configuration
      # ============================================
      - name: ğŸ“‹ Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "âŒ .env.example not found!"
            exit 1
          fi
          echo "âœ… .env.example found"

      - name: ğŸ”§ Create .env from .env.example
        run: |
          echo "ğŸ”§ Creating .env from template..."
          cp .env.example .env
          
          # Override with secrets if available
          if [ -n "${{ secrets.BASE_URL }}" ]; then
            sed -i "s|^BASE_URL=.*|BASE_URL=${{ secrets.BASE_URL }}|" .env
          fi
          
          if [ -n "${{ secrets.LOGIN_URL }}" ]; then
            sed -i "s|^LOGIN_URL=.*|LOGIN_URL=${{ secrets.LOGIN_URL }}|" .env
          fi
          
          if [ -n "${{ secrets.TEST_USERNAME }}" ]; then
            sed -i "s|^TEST_USERNAME=.*|TEST_USERNAME=${{ secrets.TEST_USERNAME }}|" .env
          fi
          
          if [ -n "${{ secrets.TEST_PASSWORD }}" ]; then
            sed -i "s|^TEST_PASSWORD=.*|TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}|" .env
          fi
          
          # Force CI settings
          sed -i "s|^HEADLESS=.*|HEADLESS=True|" .env
          sed -i "s|^SLOW_MO=.*|SLOW_MO=0|" .env
          sed -i "s|^RECORD_VIDEO=.*|RECORD_VIDEO=false|" .env
          
          # Add CI variables
          {
            echo ""
            echo "# CI Variables"
            echo "CI=true"
            echo "BROWSER=${{ matrix.browser }}"
            echo "GITHUB_RUN_ID=${{ github.run_id }}"
            echo "GITHUB_RUN_NUMBER=${{ github.run_number }}"
            echo "GITHUB_SHA=${{ github.sha }}"
          } >> .env
          
          echo "âœ… .env created"

      - name: âœ… Verify .env configuration
        run: |
          echo "ğŸ“‹ Configuration (non-sensitive):"
          grep -v -E "PASSWORD|SECRET|TOKEN" .env | grep -v "^#" | grep -v "^$" || true

      # ============================================
      # Install Dependencies
      # ============================================
      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest playwright python-dotenv
          echo "âœ… Dependencies installed"

      - name: ğŸ­ Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ğŸ­ Install Playwright Chromium
        run: |
          python -m playwright install chromium --with-deps
          echo "âœ… Playwright installed"

      # ============================================
      # Install Allure
      # ============================================
      - name: ğŸ“Š Cache Allure CLI
        id: allure-cache
        uses: actions/cache@v4
        with:
          path: /opt/allure
          key: allure-${{ runner.os }}-v2.24
          restore-keys: |
            allure-${{ runner.os }}-

      - name: ğŸ“Š Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          LATEST_URL=$(curl -sL https://api.github.com/repos/allure-framework/allure2/releases/latest \
            | grep -o 'https://.*allure.*\.zip' | head -1)
          echo "ğŸ“¥ Downloading Allure: $LATEST_URL"
          
          wget -q "$LATEST_URL" -O allure.zip
          sudo apt-get update -qq
          sudo apt-get install -y -qq unzip default-jre
          unzip -q allure.zip
          
          ALLURE_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "allure-*" | head -1)
          sudo mv "$ALLURE_DIR" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure
          echo "âœ… Allure installed"

      - name: ğŸ“Š Verify Allure installation
        run: |
          allure --version
          echo "âœ… Allure ready"

      # ============================================
      # Run Tests
      # ============================================
      - name: ğŸ“ Create test directories
        run: |
          mkdir -p allure-results test-results/screenshots
          echo "âœ… Directories created"

      - name: ğŸ§ª Run Playwright Page Tests
        continue-on-error: false
        run: |
          echo "ğŸ§ª Running Playwright tests..."
          echo "================================================"
          
          test_count=0
          passed_tests=0
          failed_tests=0
          
          test_files=$(find tests_pages -type f -name "test_*.py" 2>/dev/null | sort)
          
          if [ -z "$test_files" ]; then
            echo "âš ï¸ No test files found in tests_pages/"
            exit 0
          fi
          
          for test_file in $test_files; do
              test_count=$((test_count + 1))
              echo "ğŸ“ Running: $(basename "$test_file")"
              
              if pytest "$test_file" \
                  --browser chromium \
                  --alluredir=allure-results \
                  --tb=short \
                  -v; then
                  echo "âœ… PASSED"
                  passed_tests=$((passed_tests + 1))
              else
                  echo "âŒ FAILED"
                  failed_tests=$((failed_tests + 1))
              fi
              echo ""
          done
          
          echo "================================================"
          echo "ğŸ“Š Summary: $passed_tests passed, $failed_tests failed out of $test_count"
          echo "================================================"
          
          # Fail the job if any tests failed
          if [ $failed_tests -gt 0 ]; then
            exit 1
          fi

      # ============================================
      # Generate Report
      # ============================================
      - name: ğŸ“Š Add environment info
        if: always()
        run: |
          set -a
          # shellcheck disable=SC1090
          source <(grep -v '^#' .env | grep -v '^$' | sed 's/\r$//')
          set +a
          
          cat > allure-results/environment.properties << EOF
          Application=Candi Leasing
          Base.URL=${BASE_URL:-N/A}
          Browser=${{ matrix.browser }}
          Headless=${HEADLESS:-true}
          Python=${{ env.PYTHON_VERSION }}
          Build=${{ github.run_number }}
          Commit=${{ github.sha }}
          Branch=${{ github.ref_name }}
          Actor=${{ github.actor }}
          Timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          rm -rf allure-report
          allure generate allure-results -o allure-report --clean
          echo "âœ… Report generated with $(find allure-report -type f | wc -l) files"

      - name: ğŸ“¦ Create Report Archive
        if: always()
        run: |
          cd allure-report
          zip -r ../allure-report-${{ github.run_number }}.zip .
          cd ..
          echo "ğŸ“¦ Archive size: $(du -h allure-report-${{ github.run_number }}.zip | cut -f1)"

      # ============================================
      # Upload Artifacts
      # ============================================
      - name: ğŸ“¤ Upload Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ github.run_number }}
          path: allure-results/
          retention-days: 30
          compression-level: 6

      - name: ğŸ“¤ Upload Allure Report ZIP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-zip-${{ github.run_number }}
          path: allure-report-${{ github.run_number }}.zip
          retention-days: 30

      - name: ğŸ“¤ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots-${{ github.run_number }}
          path: test-results/screenshots/
          retention-days: 14
          if-no-files-found: ignore

      # ============================================
      # Deploy to GitHub Pages
      # ============================================
      - name: ğŸ“„ Setup Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './allure-report'

      - name: ğŸš€ Deploy to Pages
        if: always() && github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Output Report URL
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "================================================"
          echo "ğŸ“Š Allure Report: ${{ steps.deployment.outputs.page_url }}"
          echo "================================================"

      # ============================================
      # Summary
      # ============================================
      - name: ğŸ“Š Job Summary
        if: always()
        run: |
          {
            echo "# ğŸ§ª Test Execution Summary"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Build | #${{ github.run_number }} |"
            echo "| Browser | ${{ matrix.browser }} |"
            echo "| Commit | \`${{ github.sha }}\` |"
            echo "| Branch | \`${{ github.ref_name }}\` |"
            echo "| Actor | @${{ github.actor }} |"
            echo ""
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              echo "ğŸ“Š [View Report](${{ steps.deployment.outputs.page_url }})"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ============================================
      # Cleanup
      # ============================================
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f .env
          echo "âœ… Cleanup complete"