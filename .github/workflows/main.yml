name: Playwright Tests with Allure and GitHub Pages Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.14"
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      matrix:
        browser: [chromium]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      # ============================================
      # Environment Variables Setup
      # ============================================
      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          # Application Configuration
          BASE_URL=${{ secrets.BASE_URL || 'https://thirdparty.sabi.am:8443' }}
          API_BASE_URL=${{ secrets.API_BASE_URL || 'https://thirdparty.sabi.am:8443' }}
          
          # Authentication
          USERNAME=${{ secrets.TEST_USERNAME || '' }}
          PASSWORD=${{ secrets.TEST_PASSWORD || '' }}
          API_KEY=${{ secrets.API_KEY || '' }}
          API_SECRET=${{ secrets.API_SECRET || '' }}
          
          # Test Configuration
          HEADLESS=${{ secrets.HEADLESS || 'true' }}
          BROWSER=${{ matrix.browser }}
          TIMEOUT=${{ secrets.TIMEOUT || '30000' }}
          SCREENSHOT_ON_FAILURE=${{ secrets.SCREENSHOT_ON_FAILURE || 'true' }}
          
          # Environment
          ENVIRONMENT=${{ secrets.ENVIRONMENT || 'staging' }}
          CI=true
          GITHUB_RUN_ID=${{ github.run_id }}
          GITHUB_RUN_NUMBER=${{ github.run_number }}
          GITHUB_SHA=${{ github.sha }}
          
          # Optional: Database or other service URLs
          DB_HOST=${{ secrets.DB_HOST || '' }}
          DB_PORT=${{ secrets.DB_PORT || '' }}
          DB_NAME=${{ secrets.DB_NAME || '' }}
          DB_USER=${{ secrets.DB_USER || '' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD || '' }}
          
          # Optional: Third-party services
          SLACK_WEBHOOK=${{ secrets.SLACK_WEBHOOK || '' }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN || '' }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID || '' }}
          EOF
          
          echo "âœ… .env file created successfully"
          echo "ðŸ“‹ Environment variables (masked):"
          cat .env | grep -v -E "PASSWORD|SECRET|TOKEN|KEY" || true

      - name: Verify .env file
        run: |
          if [ -f .env ]; then
            echo "âœ… .env file exists"
            echo "ðŸ“Š .env file size: $(wc -c < .env) bytes"
            echo "ðŸ“ Number of variables: $(grep -c "=" .env || echo 0)"
          else
            echo "âŒ .env file not found!"
            exit 1
          fi

      # ============================================
      # Install Dependencies
      # ============================================
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install allure-pytest playwright python-dotenv

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          python -m playwright install chromium --with-deps

      # ============================================
      # Install Allure CLI
      # ============================================
      - name: Cache Allure CLI
        id: allure-cache
        uses: actions/cache@v4
        with:
          path: /opt/allure
          key: ${{ runner.os }}-allure-cli

      - name: Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest \
            | grep browser_download_url \
            | grep zip \
            | cut -d '"' -f 4)
          echo "ðŸ“¥ Downloading Allure from: $LATEST_URL"
          wget -q $LATEST_URL -O allure.zip
          sudo apt-get update -qq
          sudo apt-get install -y -qq unzip default-jre
          unzip -q allure.zip
          ALLURE_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "allure-[0-9]*" | head -n 1)
          sudo mv "$ALLURE_DIR" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure

      - name: Verify Allure installation
        run: |
          allure --version
          echo "âœ… Allure CLI installed successfully"

      # ============================================
      # Load Environment Variables
      # ============================================
      - name: Load environment variables
        run: |
          set -a
          source .env
          set +a
          echo "âœ… Environment variables loaded"
          echo "ðŸŒ BASE_URL: ${BASE_URL:-not set}"
          echo "ðŸ”§ ENVIRONMENT: ${ENVIRONMENT:-not set}"
          echo "ðŸŽ­ BROWSER: ${BROWSER:-not set}"

      # ============================================
      # Run Tests
      # ============================================
      - name: Create results directory
        run: mkdir -p allure-results

      - name: Run Playwright Page Tests
        run: |
          export $(cat .env | xargs)
          echo "ðŸ§ª Running Playwright tests..."
          
          test_count=0
          failed_tests=0
          
          for test_file in $(find tests_pages -type f -name "test_*.py" | sort); do
              test_count=$((test_count + 1))
              echo "================================================"
              echo "ðŸ“ Test $test_count: $(basename $test_file)"
              echo "================================================"
              
              if pytest "$test_file" \
                  --browser ${{ matrix.browser }} \
                  --alluredir=allure-results \