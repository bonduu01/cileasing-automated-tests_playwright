name: Playwright Tests with Allure and GitHub Pages Deployment

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'
      - '!.github/workflows/main.yaml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Prevent multiple concurrent deployments and test runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Skip if commit is from dependabot or contains [skip ci]
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      github.actor != 'dependabot[bot]'

    # Required for GitHub Pages deployment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ============================================
      # Checkout & Setup
      # ============================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: requirements.txt

      # ============================================
      # Environment Configuration
      # ============================================
      - name: ðŸ“‹ Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "âŒ .env.example not found!"
            exit 1
          fi
          echo "âœ… .env.example found"

      - name: ðŸ”§ Create .env from .env.example
        run: |
          echo "ðŸ”§ Creating .env from template..."
          cp .env.example .env
          
          # Override with secrets if available
          if [ -n "${{ secrets.BASE_URL }}" ]; then
            sed -i "s|^BASE_URL=.*|BASE_URL=${{ secrets.BASE_URL }}|" .env
          fi
          
          if [ -n "${{ secrets.LOGIN_URL }}" ]; then
            sed -i "s|^LOGIN_URL=.*|LOGIN_URL=${{ secrets.LOGIN_URL }}|" .env
          fi
          
          if [ -n "${{ secrets.TEST_USERNAME }}" ]; then
            sed -i "s|^TEST_USERNAME=.*|TEST_USERNAME=${{ secrets.TEST_USERNAME }}|" .env
          fi
          
          if [ -n "${{ secrets.TEST_PASSWORD }}" ]; then
            sed -i "s|^TEST_PASSWORD=.*|TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}|" .env
          fi
          
          # Force CI settings
          sed -i "s|^HEADLESS=.*|HEADLESS=true|" .env
          sed -i "s|^SLOW_MO=.*|SLOW_MO=0|" .env
          sed -i "s|^RECORD_VIDEO=.*|RECORD_VIDEO=false|" .env
          
          # Add CI variables
          {
            echo ""
            echo "# CI Variables"
            echo "CI=true"
            echo "BROWSER=chromium"
            echo "GITHUB_RUN_ID=${{ github.run_id }}"
            echo "GITHUB_RUN_NUMBER=${{ github.run_number }}"
            echo "GITHUB_SHA=${{ github.sha }}"
          } >> .env
          
          echo "âœ… .env created"

      - name: âœ… Verify .env configuration
        run: |
          echo "ðŸ“‹ Configuration (non-sensitive):"
          grep -v -E "PASSWORD|SECRET|TOKEN" .env | grep -v "^#" | grep -v "^$" || true

      # ============================================
      # Install Dependencies
      # ============================================
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"

      - name: ðŸŽ­ Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ðŸŽ­ Install Playwright Chromium
        run: |
          python -m playwright install chromium --with-deps
          echo "âœ… Playwright installed"

      # ============================================
      # Install Allure
      # ============================================
      - name: ðŸ“Š Cache Allure CLI
        id: allure-cache
        uses: actions/cache@v4
        with:
          path: /opt/allure
          key: allure-${{ runner.os }}-v2.24
          restore-keys: |
            allure-${{ runner.os }}-

      - name: ðŸ“Š Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          LATEST_URL=$(curl -sL https://api.github.com/repos/allure-framework/allure2/releases/latest \
            | grep -o 'https://.*allure.*\.zip' | head -1)
          echo "ðŸ“¥ Downloading Allure: $LATEST_URL"
          
          wget -q "$LATEST_URL" -O allure.zip
          sudo apt-get update -qq
          sudo apt-get install -y -qq unzip default-jre
          unzip -q allure.zip
          
          ALLURE_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "allure-*" | head -1)
          sudo mv "$ALLURE_DIR" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure
          echo "âœ… Allure installed"

      - name: ðŸ“Š Setup Allure PATH (if cached)
        if: steps.allure-cache.outputs.cache-hit == 'true'
        run: |
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure
          echo "âœ… Allure symlink restored from cache"

      - name: ðŸ“Š Verify Allure installation
        run: |
          allure --version
          which allure
          echo "âœ… Allure ready"

      # ============================================
      # Run Tests
      # ============================================
      - name: ðŸ“ Create test directories
        run: |
          mkdir -p allure-results test-results/screenshots
          echo "âœ… Directories created"

      - name: ðŸ” Discover and verify test files
        id: discover-tests
        run: |
          echo "ðŸ” Searching for test files in tests_pages/..."
          echo ""
          
          # Show directory structure
          echo "ðŸ“‚ Directory structure:"
          ls -la tests_pages/
          echo ""
          
          # Find all Python test files
          test_files=$(find tests_pages -type f -name "test_*.py" -o -name "*_test.py" | sort)
          
          if [ -z "$test_files" ]; then
            echo "âŒ No test files found!"
            echo "Expected patterns: test_*.py or *_test.py"
            exit 1
          fi
          
          echo "âœ… Found test files:"
          echo "$test_files" | while read -r file; do
            echo "  ðŸ“ $file"
          done
          echo ""
          
          test_count=$(echo "$test_files" | wc -l)
          echo "ðŸ“Š Total test files: $test_count"
          echo "total_tests=$test_count" >> $GITHUB_OUTPUT

      - name: ðŸ§ª Run Playwright Tests
        id: run-tests
        continue-on-error: true
        run: |
          echo "ðŸ§ª Running Playwright tests with pytest..."
          echo "================================================"
          
          # Run pytest with configuration from pytest.ini
          pytest tests_pages/ \
            --alluredir=allure-results \
            --verbose \
            || test_exit_code=$?
          
          echo "================================================"
          
          # Check if pytest ran successfully
          if [ "${test_exit_code:-0}" -eq 0 ]; then
            echo "âœ… All tests passed!"
            echo "test_result=success" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âš ï¸ Some tests failed (exit code: ${test_exit_code})"
            echo "test_result=failed" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the workflow, we still want the report
          fi

      # ============================================
      # Generate Report
      # ============================================
      - name: ðŸ“Š Add environment info
        if: always()
        run: |
          # Ensure allure-results directory exists
          mkdir -p allure-results
          
          # Source environment variables
          if [ -f .env ]; then
            set -a
            # shellcheck disable=SC1090
            source <(grep -v '^#' .env | grep -v '^$' | sed 's/\r$//')
            set +a
          fi
          
          # Create environment properties for Allure
          cat > allure-results/environment.properties << EOF
          Application=Candi Leasing
          Base.URL=${BASE_URL:-N/A}
          Browser=chromium
          Headless=${HEADLESS:-true}
          Python=${{ env.PYTHON_VERSION }}
          Build=${{ github.run_number }}
          Commit=${{ github.sha }}
          Branch=${{ github.ref_name }}
          Actor=${{ github.actor }}
          Workflow=${{ github.workflow }}
          Run.ID=${{ github.run_id }}
          Timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "âœ… Environment info added"

      - name: ðŸ“Š Generate Allure Report
        if: always()
        run: |
          echo "ðŸ“Š Generating Allure report..."
          echo ""
          
          # Check if we have test results
          if [ ! -d "allure-results" ] || [ -z "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "âš ï¸ No test results found, creating minimal report"
            mkdir -p allure-results
            cat > allure-results/dummy-result.json << 'EOF'
          {
            "uuid": "dummy-test",
            "name": "No tests executed",
            "status": "unknown",
            "stage": "finished",
            "start": 0,
            "stop": 0
          }
          EOF
          fi
          
          # Show what we're working with
          echo "ðŸ“‹ Allure results contents:"
          ls -lh allure-results/
          echo ""
          
          # Generate the report
          rm -rf allure-report
          allure generate allure-results -o allure-report --clean
          
          # Verify report was generated
          if [ -d "allure-report" ] && [ -f "allure-report/index.html" ]; then
            file_count=$(find allure-report -type f | wc -l)
            echo "âœ… Report generated successfully with $file_count files"
          else
            echo "âŒ Report generation failed!"
            echo "Checking for errors..."
            ls -la allure-report/ 2>/dev/null || echo "allure-report directory not created"
            exit 1
          fi

      # ============================================
      # Create .nojekyll for GitHub Pages
      # ============================================
      - name: ðŸ“„ Create .nojekyll file
        if: always()
        run: |
          touch allure-report/.nojekyll
          cp -rf ./nojekyll allure-report/
          echo "âœ… Created .nojekyll file in allure-report/"

      - name: ðŸ“¦ Create Report Archive
        if: always()
        run: |
          cd allure-report
          zip -r ../allure-report-${{ github.run_number }}.zip . -q
          cd ..
          archive_size=$(du -h allure-report-${{ github.run_number }}.zip | cut -f1)
          echo "ðŸ“¦ Archive created: $archive_size"

      # ============================================
      # Upload Artifacts
      # ============================================
      - name: ðŸ“¤ Upload Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ github.run_number }}
          path: allure-results/
          retention-days: 30
          compression-level: 6

      - name: ðŸ“¤ Upload Allure Report ZIP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-zip-${{ github.run_number }}
          path: allure-report-${{ github.run_number }}.zip
          retention-days: 30

      - name: ðŸ“¤ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots-${{ github.run_number }}
          path: test-results/screenshots/
          retention-days: 14
          if-no-files-found: ignore

      # ============================================
      # Deploy to GitHub Pages
      # ============================================
      - name: ðŸ“„ Verify report before deployment
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ” Verifying Allure report for deployment..."
          echo ""
          
          if [ ! -d "allure-report" ]; then
            echo "âŒ allure-report directory not found!"
            exit 1
          fi
          
          if [ ! -f "allure-report/index.html" ]; then
            echo "âŒ allure-report/index.html not found!"
            exit 1
          fi
          
          if [ ! -f "allure-report/.nojekyll" ]; then
            echo "âš ï¸ .nojekyll file missing, creating it..."
            touch allure-report/.nojekyll
          fi
          
          echo "âœ… Report directory verified"
          echo ""
          echo "ðŸ“ Report contents:"
          ls -lh allure-report/ | head -25
          echo ""
          echo "ðŸ“Š Total files: $(find allure-report -type f | wc -l)"
          echo "ðŸ“¦ Report size: $(du -sh allure-report/ | cut -f1)"

      - name: ðŸ“„ Setup Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload artifact to Pages
        if: always() && github.ref == 'refs/heads/main'
        id: upload-pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './allure-report'

      - name: ðŸš€ Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸŽ‰ Output Report URL
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo ""
          echo "================================================"
          echo "ðŸŽ‰ Deployment Successful!"
          echo "================================================"
          echo ""
          echo "ðŸ“Š Allure Report: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "================================================"
          echo "REPORT_URL=${{ steps.deployment.outputs.page_url }}" >> $GITHUB_ENV

      # ============================================
      # Summary
      # ============================================
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          {
            echo "# ðŸ§ª Test Execution Summary"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Status | ${{ steps.run-tests.outputs.test_result || 'unknown' }} |"
            echo "| Test Files | ${{ steps.discover-tests.outputs.total_tests || '0' }} |"
            echo "| Build | #${{ github.run_number }} |"
            echo "| Browser | chromium |"
            echo "| Python | ${{ env.PYTHON_VERSION }} |"
            echo "| Commit | \`${GITHUB_SHA:0:7}\` |"
            echo "| Branch | \`${{ github.ref_name }}\` |"
            echo "| Actor | @${{ github.actor }} |"
            echo ""
            
            if [ "${{ github.ref }}" == "refs/heads/main" ] && [ -n "${{ steps.deployment.outputs.page_url }}" ]; then
              echo "## ðŸ“Š Allure Report"
              echo ""
              echo "ðŸ”— **[View Test Report](${{ steps.deployment.outputs.page_url }})**"
              echo ""
              echo "> The report will be available in 1-2 minutes after deployment completes."
              echo ""
            fi
            
            if [ "${{ steps.run-tests.outputs.test_result }}" == "failed" ]; then
              echo "## âš ï¸ Test Failures"
              echo ""
              echo "Some tests failed. Check the detailed report above or download artifacts for more information."
              echo ""
            elif [ "${{ steps.run-tests.outputs.test_result }}" == "success" ]; then
              echo "## âœ… All Tests Passed"
              echo ""
              echo "Great job! All tests executed successfully."
              echo ""
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ============================================
      # Cleanup
      # ============================================
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f .env
          echo "âœ… Cleanup complete"