name: Playwright Tests with Allure and GitHub Pages Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.12"
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 40

    strategy:
      matrix:
        browser: [chromium]
      fail-fast: false

    steps:
      # ============================================
      # Checkout & Setup
      # ============================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      # ============================================
      # Environment Configuration
      # ============================================
      - name: ğŸ“‹ Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "âŒ .env.example not found!"
            exit 1
          fi
          echo "âœ… .env.example found"
          cat .env.example

      - name: ğŸ”§ Create .env from .env.example
        run: |
          echo "ğŸ”§ Creating .env from template..."
          cp .env.example .env
          
          # Override with secrets if available
          if [ ! -z "${{ secrets.BASE_URL }}" ]; then
            sed -i "s|^BASE_URL=.*|BASE_URL=${{ secrets.BASE_URL }}|" .env
          fi
          
          if [ ! -z "${{ secrets.LOGIN_URL }}" ]; then
            sed -i "s|^LOGIN_URL=.*|LOGIN_URL=${{ secrets.LOGIN_URL }}|" .env
          fi
          
          if [ ! -z "${{ secrets.TEST_USERNAME }}" ]; then
            sed -i "s|^TEST_USERNAME=.*|TEST_USERNAME=${{ secrets.TEST_USERNAME }}|" .env
          fi
          
          if [ ! -z "${{ secrets.TEST_PASSWORD }}" ]; then
            sed -i "s|^TEST_PASSWORD=.*|TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}|" .env
          fi
          
          # Force CI settings
          sed -i "s|^HEADLESS=.*|HEADLESS=true|" .env
          sed -i "s|^SLOW_MO=.*|SLOW_MO=0|" .env
          sed -i "s|^RECORD_VIDEO=.*|RECORD_VIDEO=false|" .env
          
          # Add CI variables
          echo "" >> .env
          echo "# CI Variables" >> .env
          echo "CI=true" >> .env
          echo "BROWSER=${{ matrix.browser }}" >> .env
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .env
          echo "GITHUB_RUN_NUMBER=${{ github.run_number }}" >> .env
          echo "GITHUB_SHA=${{ github.sha }}" >> .env
          
          echo "âœ… .env created"

      - name: âœ… Verify .env configuration
        run: |
          echo "ğŸ“‹ Configuration (non-sensitive):"
          grep -v -E "PASSWORD|SECRET|TOKEN" .env | grep -v "^#" | grep -v "^$" || true

      # ============================================
      # Install Dependencies
      # ============================================
      - name: ğŸ“¦ Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest playwright python-dotenv
          echo "âœ… Dependencies installed"

      - name: ğŸ­ Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: ğŸ­ Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          python -m playwright install chromium --with-deps
          echo "âœ… Playwright installed"

      - name: ğŸ­ Update Playwright dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          python -m playwright install-deps chromium
          echo "âœ… Dependencies updated"

      # ============================================
      # Install Allure
      # ============================================
      - name: ğŸ“Š Cache Allure CLI
        id: allure-cache
        uses: actions/cache@v4
        with:
          path: /opt/allure
          key: ${{ runner.os }}-allure-cli-v2

      - name: ğŸ“Š Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest \
            | grep browser_download_url \
            | grep zip \
            | cut -d '"' -f 4)
          echo "ğŸ“¥ Downloading Allure: $LATEST_URL"
          wget -q $LATEST_URL -O allure.zip
          sudo apt-get update -qq
          sudo apt-get install -y -qq unzip default-jre
          unzip -q allure.zip
          ALLURE_DIR=$(find . -mindepth 1 -maxdepth 1 -type d -name "allure-[0-9]*" | head -n 1)
          sudo mv "$ALLURE_DIR" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/bin/allure
          echo "âœ… Allure installed"

      - name: ğŸ“Š Verify Allure installation
        run: |
          allure --version
          echo "âœ… Allure ready"

      # ============================================
      # Run Tests
      # ============================================
      - name: ğŸ“ Create test directories
        run: |
          mkdir -p allure-results
          mkdir -p test-results/screenshots
          echo "âœ… Directories created"

      - name: ğŸ§ª Run Playwright Page Tests
        run: |
          echo "ğŸ§ª Running Playwright tests..."
          echo "================================================"
          
          test_count=0
          passed_tests=0
          failed_tests=0
          
          test_files=$(find tests_pages -type f -name "test_*.py" 2>/dev/null | sort)
          
          if [ -z "$test_files" ]; then
            echo "âš ï¸ No test files found"
            exit 0
          fi
          
          for test_file in $test_files; do
              test_count=$((test_count + 1))
              echo "ğŸ“ Running: $(basename $test_file)"
              
              if pytest "$test_file" \
                  --browser chromium \
                  --alluredir=allure-results \
                  -v; then
                  echo "âœ… PASSED"
                  passed_tests=$((passed_tests + 1))
              else
                  echo "âŒ FAILED"
                  failed_tests=$((failed_tests + 1))
              fi
              echo ""
          done
          
          echo "================================================"
          echo "ğŸ“Š Summary: $passed_tests passed, $failed_tests failed"
          echo "================================================"

      # Uncomment when ready
      # - name: ğŸ§ª Run Playwright API Tests
      #   run: |
      #     for test_file in $(find tests_api -type f -name "test_*.py"); do
      #         echo "Running $test_file..."
      #         pytest "$test_file" --browser chromium --alluredir=allure-results -v || true
      #     done

      # ============================================
      # Generate Report
      # ============================================
      - name: ğŸ“Š Add environment info
        if: always()
        run: |
          set -a
          source <(grep -v '^#' .env | grep -v '^$' | sed 's/\r$//')
          set +a
          
          cat > allure-results/environment.properties << EOF
          Application=Candi Leasing
          Base.URL=${BASE_URL}
          Browser=${{ matrix.browser }}
          Headless=${HEADLESS}
          Python=${{ env.PYTHON_VERSION }}
          Build=${{ github.run_number }}
          Commit=${{ github.sha }}
          Branch=${{ github.ref_name }}
          Actor=${{ github.actor }}
          Timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          rm -rf allure-report
          allure generate allure-results -o allure-report --clean
          ls -la allure-report
          echo "âœ… Report generated"

      - name: ğŸ“¦ Zip Allure Report
        if: always()
        run: |
          zip -r allure-report-${{ github.run_number }}.zip allure-report
          echo "ğŸ“¦ Size: $(du -h allure-report-${{ github.run_number }}.zip | cut -f1)"

      - name: ğŸ“„ Verify Report
        if: always()
        run: |
          echo "Checking allure-report directory..."
          ls -la allure-report/
          echo "Total files: $(find allure-report -type f | wc -l)"

      # ============================================
      # Upload Artifacts
      # ============================================
      - name: ğŸ“¤ Upload Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ github.run_number }}
          path: allure-results
          retention-days: 30

      - name: ğŸ“¤ Upload Allure Report ZIP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-${{ github.run_number }}
          path: allure-report-${{ github.run_number }}.zip
          retention-days: 30

      - name: ğŸ“¤ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-${{ github.run_number }}
          path: test-results/screenshots/
          retention-days: 14
          if-no-files-found: ignore

      # ============================================
      # Deploy to GitHub Pages
      # ============================================
      - name: ğŸ“„ Setup Pages
        if: always()
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: './allure-report'

      - name: ğŸš€ Deploy to Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Output Report URL
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ“Š Allure Report: ${{ steps.deployment.outputs.page_url }}"
          echo "================================================"

      # ============================================
      # Optional: Netlify Deployment
      # ============================================
      # Uncomment to enable Netlify deployment
      # - name: ğŸŒ Deploy to Netlify
      #   if: always()
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      #   run: |
      #     npm install -g netlify-cli@latest
      #
      #     if [ -z "$NETLIFY_AUTH_TOKEN" ]; then
      #       echo "Error: NETLIFY_AUTH_TOKEN not set"
      #       exit 1
      #     fi
      #
      #     if [ -z "$NETLIFY_SITE_ID" ]; then
      #       echo "Error: NETLIFY_SITE_ID not set"
      #       exit 1
      #     fi
      #
      #     echo "Deploying to Netlify..."
      #     netlify deploy \
      #       --dir=allure-report \
      #       --prod \
      #       --auth="$NETLIFY_AUTH_TOKEN" \
      #       --site="$NETLIFY_SITE_ID" \
      #       --message="Build ${{ github.run_number }}" \
      #       --json > deploy-output.json
      #
      #     if [ $? -eq 0 ]; then
      #       echo "âœ… Deployment successful!"
      #       DEPLOY_URL=$(cat deploy-output.json | grep -o '"deploy_url":"[^"]*"' | cut -d'"' -f4)
      #       echo "ğŸ“Š Netlify URL: $DEPLOY_URL"
      #     else
      #       echo "âŒ Deployment failed!"
      #       cat deploy-output.json
      #       exit 1
      #     fi

      # ============================================
      # Summary
      # ============================================
      - name: ğŸ“Š Job Summary
        if: always()
        run: |
          echo "# ğŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | ${{ matrix.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [View Report](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Cleanup
      # ============================================
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f .env
          echo "âœ… Cleanup complete"